<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Tabulator: rowAdded로 _rid 자동생성</title>

  <!-- Tabulator CSS -->
  <link href="https://unpkg.com/tabulator-tables@latest/dist/css/tabulator.min.css" rel="stylesheet">

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; }
    .toolbar { display:flex; gap:8px; margin-bottom:12px; flex-wrap: wrap; }
    #table { height: 420px; }
    button { padding: 6px 10px; border:1px solid #ddd; background:#f7f7f7; border-radius:6px; cursor:pointer; }
    button:hover { background:#eee; }
  </style>
</head>
<body>

  <h1>rowSelection + _rid 자동 생성(초기 데이터 보정 포함)</h1>

  <div class="toolbar">
    <button id="add-row">행 추가</button>
    <button id="del-row">선택 행 삭제</button>
    <button id="export-csv">CSV 내보내기</button>
  </div>

  <div id="table" tabindex="0"></div>

  <!-- Tabulator JS -->
  <script src="https://unpkg.com/tabulator-tables@latest/dist/js/tabulator.min.js"></script>
  <script>
    // ✅ 유틸: _rid 생성기 (중복 최소화)
    function genRid(){
      // 날짜기반 + 랜덤 문자열 결합
      return "r" + Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
    }

    // ✅ 초기 데이터: _rid 없어도 OK (dataLoaded에서 자동 보정)
    const tableData = [
      { id:"1", name:"홍길동", age:"29", city:"서울",   join:"2024-10-01", score:"83" },
      { id:"2", name:"김아름", age:"32", city:"부산",   join:"2023-07-12", score:"91" },
      { id:"3", name:"이준호", age:"26", city:"대구",   join:"2025-01-10", score:"75" },
      { id:"4", name:"박지민", age:"41", city:"인천",   join:"2022-03-30", score:"88" },
    ];

    // ✅ Tabulator 생성
    const table = new Tabulator("#table", {
      data: tableData,
      index: "_rid",              // 내부 고유키로 사용 → 반드시 모든 행에 존재해야 함
      layout: "fitColumns",
      height: "420px",

      // ✅ 행 선택을 '체크박스 컬럼'으로 명확하게 (보편적인 패턴)
      selectable: true,           // 행 선택 활성화
      selectableRange: true,

      movableColumns: true,
      resizableRows: true,

      clipboard: true,
      clipboardPasteAction: "update",

      editTriggerEvent: "dblclick",

      columns: [
        // ✅ 체크박스 선택 컬럼(가장 많이 쓰는 방식)
        { formatter:"rowSelection", titleFormatter:"rowSelection", hozAlign:"center", width:44, headerSort:false, frozen:true },

        // 보조: 행 번호
        { title:"", formatter:"rownum", hozAlign:"right", width:60, headerSort:false, frozen:true },

        { title:"ID",   field:"id",   width:80, editor:"input" },
        { title:"이름", field:"name", editor:"input" },
        { title:"나이", field:"age",  width:90, editor:"input" },
        { title:"도시", field:"city", editor:"input" },
        { title:"입사일", field:"join", editor:"input" },
        { title:"점수", field:"score", width:90, editor:"input" },
      ],
    });

    // ✅ 초기 로드된 데이터에도 _rid 자동 보정 (중요!)
    //   - 초기 data 옵션으로 넣은 행들은 rowAdded 이벤트가 호출되지 않음
    table.on("dataLoaded", function(data){
      this.getRows().forEach(row => {
        const d = row.getData();
        if (!d._rid){
          row.update({_rid: genRid()}); // 초기행에도 _rid 채워줌
        }
      });
    });

    // ✅ rowAdded 이벤트로 이후 추가되는 행의 _rid 자동 생성
    table.on("rowAdded", (row) => {
      const data = row.getData();
      if (!data._rid) {
        row.update({ _rid: genRid() });
      }
    });

    // ✅ 행 추가
    document.getElementById("add-row").addEventListener("click", () => {
      // 주의: _rid는 rowAdded에서 자동으로 붙음
      table.addRow({ id:"", name:"", age:"", city:"", join:"", score:"" }, true);
    });

    // ✅ 선택 행 삭제 (체크박스 기준) — 가장 보편적인 구현
    document.getElementById("del-row").addEventListener("click", () => {
      const selectedRows = table.getSelectedRows(); // 체크박스로 선택된 행들
      if (selectedRows.length === 0) {
        alert("삭제할 행을 체크박스로 선택하세요.");
        return;
      }
      // 성능상 한 번에 배열로 넘기는 것도 가능: table.deleteRow(selectedRows)
      selectedRows.forEach(r => r.delete());
    });

    // ✅ CSV 내보내기
    document.getElementById("export-csv").addEventListener("click", () => {
      table.download("csv", "table-export.csv");
    });

    // ✅ Ctrl+C 복사 기능 유지 (셀 범위 선택을 끈 상태라도, 포커스된 셀/행 기준으로 동작)
    //    - 만약 셀 범위 복사가 꼭 필요하면 selectableRange를 다시 true로 바꾸고 사용
    const tableEl = document.getElementById("table");
    tableEl.addEventListener("keydown", (e) => {
      const isMac = navigator.platform.toUpperCase().includes("MAC");
      const copyCombo = (isMac && e.metaKey && e.key.toLowerCase() === "c") ||
                        (!isMac && e.ctrlKey && e.key.toLowerCase() === "c");
      if (copyCombo) {
        // 선택된 셀/행을 복사 — 선택 정책에 따라 Tabulator가 적절히 처리
        table.copyToClipboard("selected");
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
