<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Tabulator 바닐라 예시 (정리본)</title>

  <!-- Tabulator CSS (CDN)
       ※ 최신 버전. 특정 버전을 고정하려면 @6.x 처럼 지정하세요. -->
  <link href="https://unpkg.com/tabulator-tables@latest/dist/css/tabulator.min.css" rel="stylesheet">

  <style>
    /* ===== 최소 스타일 ===== */
    :root { --gap: 8px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; }
    .toolbar { display:flex; gap:var(--gap); margin-bottom:12px; flex-wrap: wrap; }
    #table { height: 420px; } /* 고정 높이: 가상 스크롤 */
    .note { color:#555; font-size: 13px; margin-top: 8px; }
    .search { width: 220px; padding: 6px 8px; }
    button { padding: 6px 10px; border:1px solid #ddd; background:#f7f7f7; border-radius:6px; cursor:pointer; }
    button:hover { background:#eee; }
  </style>
</head>
<body>

  <h1>Tabulator 바닐라 JS 예시</h1>

  <!-- ===== 툴바 ===== -->
  <div class="toolbar" role="toolbar" aria-label="테이블 도구 막대">
    <!-- 검색 입력 -->
    <input id="search" class="search" type="text" placeholder="이름/도시 검색 (실시간 필터)" aria-label="이름 또는 도시 검색" />

    <!-- 행 조작 -->
    <button id="add-row" type="button">행 추가</button>
    <button id="del-row" type="button">선택 행 삭제</button>

    <!-- 클립보드 제어 -->
    <button id="copy" type="button">선택 영역 복사</button>
    <button id="paste" type="button">붙여넣기 안내</button>

    <!-- 내보내기 -->
    <button id="export-csv" type="button">CSV 내보내기</button>
  </div>

  <!-- ===== 테이블 컨테이너 ===== -->
  <div id="table" tabindex="0" aria-label="데이터 테이블"></div>
  <div class="note">
    Tip: 마우스로 셀을 드래그해 범위를 선택한 뒤 <b>Ctrl+C</b>로 복사하여 엑셀/메모장 등에 붙여넣기 할 수 있습니다.
  </div>

  <!-- Tabulator JS (CDN) -->
  <script src="https://unpkg.com/tabulator-tables@latest/dist/js/tabulator.min.js"></script>

  <script>
    // =========================
    // 1) 데이터/컬럼/옵션 정의
    // =========================

    /* 데모용 초기 데이터 */
    const DATA = [
      { id:1, name:"홍길동", age:29, city:"서울", join:"2024-10-01", score:83 },
      { id:2, name:"김아름", age:32, city:"부산", join:"2023-07-12", score:91 },
      { id:3, name:"이준호", age:26, city:"대구", join:"2025-01-10", score:75 },
      { id:4, name:"박지민", age:41, city:"인천", join:"2022-03-30", score:88 },
    ];

    /* 컬럼 정의 */
    const COLUMNS = [
      { title:"ID", field:"id", width:70, headerSort:true, editor:"input" },
      { title:"이름", field:"name", width:80, headerSort:true, editor:"input" },
      {
        title:"나이", field:"age", width:80, hozAlign:"right", editor:"number",
        // 숫자 범위 검증 (18~120)
        validator: [{ type:"min", parameters:18 }, { type:"max", parameters:120 }],
      },
      { title:"도시", field:"city", width:70, headerSort:true, editor:"input" },
      {
        title:"입사일", field:"join", width:90, editor:"input",
        // 간단 날짜 포맷 검증(YYYY-MM-DD) — 빈 값은 허용
        validator: (cell, value) => /^\d{4}-\d{2}-\d{2}$/.test(value) || value === "",
      },
      {
        title:"점수", field:"score", width:90, hozAlign:"right", editor:"number",
        // 점수 라벨링(★, 👍) — 보기 편의용
        formatter: (cell) => {
          const v = Number(cell.getValue());
          if (Number.isNaN(v)) return "";
          if (v >= 90) return `⭐ ${v}`;
          if (v >= 80) return `👍 ${v}`;
          return `${v}`;
        },
      },
    ];

    /* Tabulator 옵션 */
    const OPTIONS = {
      data: DATA,                 // 초기 데이터
      index: "id",                // 각 행의 고유키(중복X)
      layout: "fitColumns",       // 컬럼 너비 자동맞춤
      height: "420px",            // 가상 스크롤
      selectable: true,           // 행 선택 가능(행 삭제 등에 사용)
      movableColumns: true,       // 컬럼 드래그로 순서변경
      resizableRows: true,        // 행높이 조절

      // ✅ 클립보드 & 범위 선택 (여러 셀 복사용)
      clipboard: true,                 // 클립보드 모듈 활성화
      clipboardPasteAction: "update",  // 붙여넣기 시 기존 셀 업데이트
      selectableRange: true,           // 마우스 드래그로 셀 범위 선택
      selectableRangeMode: "cell",     // 선택 단위를 '셀'로 고정
      selectableRangeRows: true,       // 행 단위 드래그 허용
      selectableRangeColumns: true,    // 컬럼 단위 드래그 허용

      // 복사 시 헤더 포함 등 상세 설정 (필요 시 켜세요)
      clipboardCopyConfig: {
        columnHeaders: false,   // true면 첫 행에 컬럼헤더 추가
        rowHeaders: false,
        columnGroups: false,
      },
      columns: COLUMNS,
    };

    // =========================
    // 2) Tabulator 생성
    // =========================
    const table = new Tabulator("#table", OPTIONS);

    // =========================
    // 3) 유틸 함수
    // =========================

    /**
     * 선택된 셀/행 복사를 실행.
     * - 최신 Tabulator는 "range" 복사 지원.
     * - 버전/환경에 따라 "range" 미지원 시 "selected"로 폴백.
     */
    function copySelectedToClipboard() {
      try {
        table.copyToClipboard("range");     // 우선: 선택 '셀 범위' 복사
      } catch (e) {
        table.copyToClipboard("selected");  // 폴백: 선택 '행' 복사
      }
    }

    /**
     * 입력 요소 편집 중 여부 판단.
     * - 편집 중에는 Ctrl+C 기본 동작(텍스트 복사)을 방해하지 않기 위함.
     */
    function isEditingTarget(target) {
      if (!target) return false;
      const tag = target.tagName ? target.tagName.toLowerCase() : "";
      return tag === "input" || tag === "textarea" || target.isContentEditable;
    }

    /**
     * 간단 디바운스 (검색 최적화)
     */
    function debounce(fn, delay = 150) {
      let t = null;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(null, args), delay);
      };
    }

    // =========================
    // 4) 키보드/이벤트 바인딩
    // =========================

    // Ctrl/Cmd + C => 범위 복사 (테이블 컨테이너가 포커스 상태일 때)
    const tableEl = document.getElementById("table");
    tableEl.addEventListener("keydown", (ev) => {
      const isMac = navigator.platform.toUpperCase().includes("MAC");
      const ctrlOrCmd = isMac ? ev.metaKey : ev.ctrlKey;

      // 편집 중이면 기본 동작 유지 (셀 에디터 입력 복사)
      if (ctrlOrCmd && ev.key.toLowerCase() === "c" && !isEditingTarget(ev.target)) {
        ev.preventDefault();           // 기본 복사 차단
        copySelectedToClipboard();     // 커스텀 복사 실행
      }
    });

    // 검색(실시간 OR 필터) — 디바운스 적용
    const searchInput = document.getElementById("search");
    searchInput.addEventListener("input", debounce(() => {
      const q = searchInput.value.trim();
      if (!q) {
        table.clearFilter();
      } else {
        // 이름/도시 컬럼 OR 필터 (부분일치)
        table.setFilter([
          [
            { field:"name", type:"like", value:q },
            { field:"city", type:"like", value:q },
          ]
        ]);
      }
    }, 200));

    // 행 추가
    document.getElementById("add-row").addEventListener("click", () => {
      // 간단 유니크 ID — 실제 환경에서는 서버 발급 ID를 권장
      const newId = Date.now();
      table.addRow({ id:newId, name:"", age:null, city:"", join:"", score:null }, true);
    });

    // 선택 행 삭제
    document.getElementById("del-row").addEventListener("click", () => {
      const selected = table.getSelectedRows();
      if (selected.length === 0) {
        alert("삭제할 행을 선택하세요.");
        return;
      }
      selected.forEach(r => r.delete());
    });

    // 선택 영역 복사 (버튼)
    document.getElementById("copy").addEventListener("click", () => {
      copySelectedToClipboard();
    });

    // 붙여넣기 안내 (붙여넣기는 셀 포커스 후 Ctrl+V)
    document.getElementById("paste").addEventListener("click", () => {
      alert("붙여넣기를 하려면 셀을 한번 클릭하고 Ctrl+V를 누르세요.");
    });

    // CSV 내보내기
    document.getElementById("export-csv").addEventListener("click", () => {
      table.download("csv", "table-export.csv");
      // 참고: XLSX 내보내기는 sheetjs(xlsx) 추가 로드 필요
    });

    // 셀 편집 콜백(숫자 검증 보조 안내)
    table.on("cellEdited", (cell) => {
      const field = cell.getField();
      const value = cell.getValue();

      // 'age', 'score'는 숫자만 허용 — 숫자 아님을 입력했을 때 롤백
      if ((field === "age" || field === "score") && value !== null && value !== "" && isNaN(Number(value))) {
        alert(`'${field}'에는 숫자만 입력하세요.`);
        cell.restoreOldValue();
      }
    });
  </script>
</body>
</html>
